#!/usr/bin/env python3
"""Manage entities. No external dependencies."""
import argparse
import json
import sqlite3
import sys
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
BASE_DIR = SCRIPT_DIR.parent
DB_PATH = BASE_DIR / "oink.db"


def get_db():
    """Get database connection with foreign keys enabled."""
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    conn.execute("PRAGMA foreign_keys = ON")
    return conn


def cmd_add(args):
    """Add a new entity."""
    conn = get_db()

    # Check for duplicates (case-insensitive)
    existing = conn.execute("SELECT id FROM entities WHERE name = ? COLLATE NOCASE", (args.name,)).fetchone()
    if existing:
        if args.json:
            print(json.dumps({"error": f"Entity '{args.name}' already exists"}))
        else:
            print(f"Entity '{args.name}' already exists")
        sys.exit(1)

    cursor = conn.execute(
        "INSERT INTO entities (name, description) VALUES (?, ?)",
        (args.name, args.description)
    )
    entity_id = cursor.lastrowid
    conn.commit()
    conn.close()

    if args.json:
        print(json.dumps({"success": True, "id": entity_id, "name": args.name}))
    else:
        print(f"Created entity: {args.name} (id={entity_id})")


def cmd_update(args):
    """Update an entity."""
    conn = get_db()

    entity = conn.execute("SELECT id FROM entities WHERE name = ? COLLATE NOCASE", (args.name,)).fetchone()
    if not entity:
        if args.json:
            print(json.dumps({"error": f"Entity '{args.name}' not found"}))
        else:
            print(f"Entity '{args.name}' not found")
        sys.exit(1)

    if args.description is not None:
        conn.execute("UPDATE entities SET description = ? WHERE id = ?", (args.description, entity['id']))
        conn.commit()

    if args.json:
        print(json.dumps({"success": True, "name": args.name}))
    else:
        print(f"Updated entity: {args.name}")

    conn.close()


def cmd_delete(args):
    """Delete an entity."""
    conn = get_db()

    entity = conn.execute("SELECT id FROM entities WHERE name = ? COLLATE NOCASE", (args.name,)).fetchone()
    if not entity:
        if args.json:
            print(json.dumps({"error": f"Entity '{args.name}' not found"}))
        else:
            print(f"Entity '{args.name}' not found")
        sys.exit(1)

    # Check for accounts
    account_count = conn.execute(
        "SELECT COUNT(*) FROM accounts WHERE entity_id = ?", (entity['id'],)
    ).fetchone()[0]

    if account_count > 0:
        if args.json:
            print(json.dumps({
                "error": f"Cannot delete entity '{args.name}': has {account_count} account(s)",
                "hint": "Delete accounts first"
            }))
        else:
            print(f"Cannot delete entity '{args.name}': has {account_count} account(s)")
            print("Delete accounts first with: ./scripts/account delete --name <account>")
        sys.exit(1)

    # Check for categories
    category_count = conn.execute(
        "SELECT COUNT(*) FROM categories WHERE entity_id = ?", (entity['id'],)
    ).fetchone()[0]

    if category_count > 0:
        if args.json:
            print(json.dumps({
                "error": f"Cannot delete entity '{args.name}': has {category_count} category(ies)",
                "hint": "Delete categories first"
            }))
        else:
            print(f"Cannot delete entity '{args.name}': has {category_count} category(ies)")
            print("Delete categories first with: ./scripts/category delete --entity <entity> --name <category>")
        sys.exit(1)

    # Check for patterns
    pattern_count = conn.execute(
        "SELECT COUNT(*) FROM transaction_patterns WHERE entity_id = ?", (entity['id'],)
    ).fetchone()[0]

    if pattern_count > 0:
        if args.json:
            print(json.dumps({
                "error": f"Cannot delete entity '{args.name}': has {pattern_count} pattern(s)",
                "hint": "Delete patterns first"
            }))
        else:
            print(f"Cannot delete entity '{args.name}': has {pattern_count} pattern(s)")
            print("Delete patterns first with: ./scripts/pattern delete --id <pattern_id>")
        sys.exit(1)

    conn.execute("DELETE FROM entities WHERE id = ?", (entity['id'],))
    conn.commit()
    conn.close()

    if args.json:
        print(json.dumps({"success": True, "name": args.name}))
    else:
        print(f"Deleted entity: {args.name}")


def cmd_list(args):
    """List all entities."""
    conn = get_db()

    rows = conn.execute("""
        SELECT e.id, e.name, e.description,
               COUNT(DISTINCT a.id) as account_count,
               COUNT(t.id) as tx_count
        FROM entities e
        LEFT JOIN accounts a ON e.id = a.entity_id
        LEFT JOIN transactions t ON a.id = t.account_id
        GROUP BY e.id
        ORDER BY e.name
    """).fetchall()

    conn.close()

    if args.json:
        print(json.dumps({"entities": [dict(r) for r in rows]}))
    else:
        if not rows:
            print("No entities found. Create one with: ./scripts/entity add --name 'Personal'")
            return

        print(f"\n{'ID':<4} {'Name':<15} {'Accounts':>10} {'Transactions':>12} {'Description':<30}")
        print("-" * 75)
        for row in rows:
            desc = (row['description'] or '')[:28]
            print(f"{row['id']:<4} {row['name']:<15} {row['account_count']:>10} {row['tx_count']:>12} {desc:<30}")


def main():
    parser = argparse.ArgumentParser(description="Manage Oink entities")
    subparsers = parser.add_subparsers(dest="command", help="Command")

    # add
    add_parser = subparsers.add_parser("add", help="Add a new entity")
    add_parser.add_argument("--name", required=True, help="Entity name")
    add_parser.add_argument("--description", help="Description")
    add_parser.add_argument("--json", action="store_true", help="Output JSON")

    # update
    update_parser = subparsers.add_parser("update", help="Update an entity")
    update_parser.add_argument("--name", required=True, help="Entity name")
    update_parser.add_argument("--description", help="New description")
    update_parser.add_argument("--json", action="store_true", help="Output JSON")

    # delete
    delete_parser = subparsers.add_parser("delete", help="Delete an entity")
    delete_parser.add_argument("--name", required=True, help="Entity name")
    delete_parser.add_argument("--json", action="store_true", help="Output JSON")

    # list
    list_parser = subparsers.add_parser("list", help="List all entities")
    list_parser.add_argument("--json", action="store_true", help="Output JSON")

    args = parser.parse_args()

    if not DB_PATH.exists():
        if getattr(args, 'json', False):
            print(json.dumps({"error": "Database not found. Run ./scripts/init first."}))
        else:
            print("Database not found. Run ./scripts/init first.")
        sys.exit(1)

    if args.command == "add":
        cmd_add(args)
    elif args.command == "update":
        cmd_update(args)
    elif args.command == "delete":
        cmd_delete(args)
    elif args.command == "list":
        cmd_list(args)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
